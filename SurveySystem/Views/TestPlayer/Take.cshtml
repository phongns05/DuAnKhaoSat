@model (SurveySystem.Models.Test test, SurveySystem.Models.TestAttempt attempt)
@{
    ViewData["Title"] = Model.test.Title;
    var attemptId = (int)ViewData["AttemptId"];
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@Model.test.Title</h2>
    <div>
        <span class="badge bg-info text-dark">Thời gian: @Model.test.Duration phút</span>
        <span class="ms-2" id="timer"></span>
    </div>
}</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

<form id="testForm" asp-action="Submit" method="post">
    <input type="hidden" name="attemptId" value="@attemptId" />
    <ol>
        @foreach (var tq in Model.test.TestQuestions)
        {
            var q = tq.Question;
            <li class="mb-3">
                <div class="fw-semibold mb-1">@q.Content</div>
                @if ((q.QuestionType ?? "").ToLower().Contains("essay"))
                {
                    <textarea class="form-control" name="qtext_@q.QuestionId" rows="3"></textarea>
                }
                else
                {
                    foreach (var opt in q.QuestionOptions)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q_@q.QuestionId" value="@opt.OptionId" id="opt_@opt.OptionId">
                            <label class="form-check-label" for="opt_@opt.OptionId">@opt.Content</label>
                        </div>
                    }
                }
            </li>
        }
    </ol>
    <div class="d-flex gap-2">
        <button formaction="@Url.Action("SaveDraft")" class="btn btn-outline-secondary" type="submit">Lưu nháp</button>
        <button class="btn btn-primary" type="submit">Nộp bài</button>
    </div>
</form>

@section Scripts{
    <script>
        (function(){
            const durationMinutes = @Model.test.Duration;
            const start = new Date("@Model.attempt.StartTime?.ToUniversalTime().ToString("o")");
            const end = new Date(start.getTime() + durationMinutes*60000);
            function tick(){
                const now = new Date();
                const diff = end - now;
                const el = document.getElementById('timer');
                if(diff <= 0){
                    el.textContent = 'Hết giờ';
                    document.getElementById('testForm').submit();
                    return;
                }
                const m = Math.floor(diff/60000);
                const s = Math.floor((diff%60000)/1000);
                el.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                setTimeout(tick, 1000);
            }
            tick();
        })();
    </script>
}

